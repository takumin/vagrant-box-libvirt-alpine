version: 2
jobs:
  build:
    machine: true
    steps:
      - checkout
      - run:
          name: Git Submodules
          command: git submodule update --init --recursive
      - run:
          name: Install Required Packages
          command: |
            echo 'deb http://archive.ubuntu.com/ubuntu artful main universe' | sudo tee /etc/apt/sources.list.d/ubuntu-artful.list
            export DEBIAN_FRONTEND="noninteractive"
            export DEBIAN_PRIORITY="critical"
            export DEBCONF_NONINTERACTIVE_SEEN="true"
            sudo apt-get -q update
            sudo apt-get -q install -y --no-install-recommends --target-release artful qemu-user-static
      - run:
          name: Creating Base Image - x86_64
          command: >-
            sudo
            ALPINE_BRANCH="v3.9"
            ALPINE_MIRROR="http://dl-cdn.alpinelinux.org/alpine"
            ALPINE_PACKAGES="build-base ca-certificates ssl_client"
            ARCH="x86_64"
            CHROOT_DIR="/alpine-x86_64"
            CHROOT_KEEP_VARS="ARCH CI QEMU_EMULATOR CIRCLE__.*"
            ./alpine-chroot-install/alpine-chroot-install
      - run:
          name: Creating Base Image - armhf
          command: >-
            sudo
            ALPINE_BRANCH="v3.9"
            ALPINE_MIRROR="http://dl-cdn.alpinelinux.org/alpine"
            ALPINE_PACKAGES="build-base ca-certificates ssl_client"
            ARCH="armhf"
            CHROOT_DIR="/alpine-armhf"
            CHROOT_KEEP_VARS="ARCH CI QEMU_EMULATOR CIRCLE__.*"
            ./alpine-chroot-install/alpine-chroot-install
      - run:
          name: Creating Base Image - aarch64
          command: >-
            sudo
            ALPINE_BRANCH="v3.9"
            ALPINE_MIRROR="http://dl-cdn.alpinelinux.org/alpine"
            ALPINE_PACKAGES="build-base ca-certificates ssl_client"
            ARCH="aarch64"
            CHROOT_DIR="/alpine-aarch64"
            CHROOT_KEEP_VARS="ARCH CI QEMU_EMULATOR CIRCLE__.*"
            ./alpine-chroot-install/alpine-chroot-install
